# CRNNéªŒè¯ç è¯†åˆ«

åŸºäºPyTorchçš„CRNNï¼ˆCNN+LSTM+CTCï¼‰éªŒè¯ç è¯†åˆ«æ¨¡å‹ï¼Œæ”¯æŒ4-8ä½é•¿åº¦ä¸å®šçš„è‹±æ–‡æ•°å­—éªŒè¯ç è¯†åˆ«ã€‚

## ç‰¹æ€§

- ğŸ¯ æ”¯æŒå˜é•¿éªŒè¯ç è¯†åˆ«ï¼ˆ4-8ä½ï¼‰
- ğŸ”¤ æ”¯æŒå¤§å°å†™è‹±æ–‡å­—æ¯å’Œæ•°å­—ï¼ˆ62ä¸ªå­—ç¬¦ï¼‰
- ğŸ§  **åŒæ¶æ„æ”¯æŒ**ï¼šåŸºç¡€CNN + ResNet50é¢„è®­ç»ƒæ¨¡å‹
- ğŸ”§ **çµæ´»è®­ç»ƒç­–ç•¥**ï¼šæ”¯æŒéª¨å¹²ç½‘ç»œå†»ç»“å’Œå·®åˆ†å­¦ä¹ ç‡
- ğŸ“Š ä½¿ç”¨CTCæŸå¤±å‡½æ•°ï¼Œæ— éœ€å­—ç¬¦çº§å¯¹é½
- ğŸ¤– è‡ªåŠ¨ç”Ÿæˆè®­ç»ƒæ•°æ®
- ğŸš€ å®Œæ•´çš„è®­ç»ƒã€æ¨ç†å’Œè¯„ä¼°æµç¨‹

## é¡¹ç›®ç»“æ„

```
AntiCaptchaML/
â”œâ”€â”€ data/                   # æ•°æ®ç›®å½•ï¼ˆè¢«.gitignoreå¿½ç•¥ï¼‰
â”œâ”€â”€ models/                 # æ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ crnn.py            # åŸºç¡€CRNNæ¨¡å‹
â”‚   â””â”€â”€ crnn_resnet.py     # ResNet-CRNNæ¨¡å‹
â”œâ”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ dataset.py         # æ•°æ®é›†ç±»
â”‚   â””â”€â”€ metrics.py         # è¯„ä¼°æŒ‡æ ‡
â”œâ”€â”€ checkpoints/           # æ¨¡å‹æƒé‡ï¼ˆè¢«.gitignoreå¿½ç•¥ï¼‰
â”œâ”€â”€ output/               # è¾“å‡ºç»“æœï¼ˆè¢«.gitignoreå¿½ç•¥ï¼‰
â”œâ”€â”€ generate_data.py      # æ•°æ®ç”Ÿæˆè„šæœ¬
â”œâ”€â”€ train.py             # è®­ç»ƒè„šæœ¬
â”œâ”€â”€ inference.py         # æ¨ç†è„šæœ¬
â”œâ”€â”€ quick_start.py       # å¿«é€Ÿå¼€å§‹è„šæœ¬
â”œâ”€â”€ requirements.txt     # ä¾èµ–åŒ…
â””â”€â”€ README.md           # è¯´æ˜æ–‡æ¡£
```

## å®‰è£…ä¾èµ–

### ä½¿ç”¨uvï¼ˆæ¨èï¼‰
```bash
uv venv -p 3.12
uv pip install -r requirements.txt
```

### ä½¿ç”¨pip
```bash
pip install -r requirements.txt
```

## ä½¿ç”¨æ–¹æ³•

### 1. å¿«é€Ÿå¼€å§‹

```bash
# ä¸€é”®å®Œæˆæ•°æ®ç”Ÿæˆã€è®­ç»ƒå’Œè¯„ä¼°
uv run python quick_start.py --num_samples 10000 --num_epochs 20

# æˆ–è€…å•ç‹¬è¿è¡Œå„ä¸ªæ­¥éª¤...
```

### 2. ç”Ÿæˆè®­ç»ƒæ•°æ®

```bash
# ç”Ÿæˆ5ä¸‡ä¸ªæ ·æœ¬
uv run python generate_data.py --output_dir ./data --num_samples 50000

# è‡ªå®šä¹‰å›¾åƒå°ºå¯¸
uv run python generate_data.py --output_dir ./data --num_samples 10000 --width 160 --height 60
```

**å‚æ•°è¯´æ˜ï¼š**
- `--output_dir`: æ•°æ®ä¿å­˜ç›®å½•
- `--num_samples`: æ€»æ ·æœ¬æ•°
- `--width`: å›¾ç‰‡å®½åº¦ï¼ˆé»˜è®¤160ï¼‰
- `--height`: å›¾ç‰‡é«˜åº¦ï¼ˆé»˜è®¤60ï¼‰

### 3. æ¨¡å‹è®­ç»ƒ

#### ğŸ§  ResNet50æ¶æ„ï¼ˆæ¨èï¼‰

```bash
# åŸºç¡€è®­ç»ƒ - å†»ç»“æ—©æœŸå±‚
uv run python train.py --backbone resnet --freeze_backbone early --lr 1e-3 --batch_size 32 --num_epochs 50

# ä½¿ç”¨SafeTensorsæ ¼å¼ä¿å­˜æ¨¡å‹
uv run python train.py --backbone resnet --freeze_backbone early --save_format safetensors

# é€‚ç”¨äºå¤§æ•°æ®é›† - å®Œå…¨å¾®è°ƒ
uv run python train.py --backbone resnet --freeze_backbone none --lr 5e-4 --backbone_lr_ratio 0.5 --batch_size 16

# é€‚ç”¨äºå°æ•°æ®é›† - å†»ç»“æ‰€æœ‰å±‚
uv run python train.py --backbone resnet --freeze_backbone all --lr 1e-3 --batch_size 64

# åˆ†é˜¶æ®µè®­ç»ƒ - åªè®­ç»ƒæœ€åstage
uv run python train.py --backbone resnet --freeze_backbone partial --lr 1e-3 --backbone_lr_ratio 0.1
```

#### ğŸ“Š åŸºç¡€CNNæ¶æ„

```bash
# åŸºç¡€CRNNæ¨¡å‹
uv run python train.py --backbone basic --lr 1e-3 --batch_size 32 --num_epochs 100
```

**æ ¸å¿ƒå‚æ•°è¯´æ˜ï¼š**
- `--backbone`: æ¨¡å‹æ¶æ„ (`basic` | `resnet`)
- `--freeze_backbone`: ResNetå†»ç»“ç­–ç•¥ (`none` | `all` | `early` | `partial`)
- `--backbone_lr_ratio`: ResNetç›¸å¯¹å­¦ä¹ ç‡æ¯”ä¾‹ï¼ˆé»˜è®¤0.1ï¼‰
- `--pretrained`: ä½¿ç”¨é¢„è®­ç»ƒæƒé‡ï¼ˆé»˜è®¤Trueï¼‰
- `--save_format`: æ¨¡å‹ä¿å­˜æ ¼å¼ (`pth` | `safetensors`)
- `--lr`: åŸºç¡€å­¦ä¹ ç‡
- `--batch_size`: æ‰¹æ¬¡å¤§å°
- `--num_epochs`: è®­ç»ƒè½®æ•°
- `--hidden_size`: LSTMéšè—å±‚å¤§å°ï¼ˆé»˜è®¤256ï¼‰
- `--num_layers`: LSTMå±‚æ•°ï¼ˆé»˜è®¤2ï¼‰

#### ğŸ¯ ä¸åŒæ•°æ®é‡çš„æ¨èé…ç½®

```bash
# å°æ•°æ®é›† (<10kæ ·æœ¬) - é¿å…è¿‡æ‹Ÿåˆ
uv run python train.py --backbone resnet --freeze_backbone all --lr 1e-3 --batch_size 64

# ä¸­ç­‰æ•°æ®é›† (10k-50kæ ·æœ¬) - å¹³è¡¡æ€§èƒ½
uv run python train.py --backbone resnet --freeze_backbone early --lr 1e-3 --backbone_lr_ratio 0.1

# å¤§æ•°æ®é›† (>50kæ ·æœ¬) - å……åˆ†åˆ©ç”¨æ•°æ®
uv run python train.py --backbone resnet --freeze_backbone none --lr 5e-4 --backbone_lr_ratio 0.5
```

### 4. æ¨ç†é¢„æµ‹

#### å•å¼ å›¾ç‰‡é¢„æµ‹
```bash
# é¢„æµ‹å•å¼ å›¾ç‰‡å¹¶å¯è§†åŒ–
uv run python inference.py --model_path ./checkpoints/best.pth --mode single --image_path test.png --visualize

# ç®€å•é¢„æµ‹
uv run python inference.py --model_path ./checkpoints/best.pth --mode single --image_path test.png
```

#### æ‰¹é‡é¢„æµ‹
```bash
# æ‰¹é‡å¤„ç†å›¾ç‰‡ç›®å½•
uv run python inference.py --model_path ./checkpoints/best.pth --mode batch --image_dir ./test_images --output_path results.txt
```

#### æ¨¡å‹è¯„ä¼°
```bash
# åœ¨æµ‹è¯•é›†ä¸Šè¯„ä¼°æ¨¡å‹æ€§èƒ½
uv run python inference.py --model_path ./checkpoints/best.pth --mode evaluate --data_root ./data --output_path eval_results.txt

# ä½¿ç”¨SafeTensoræ ¼å¼æ¨¡å‹è¿›è¡Œæ¨ç†
uv run python inference.py --model_path ./checkpoints/best.safetensors --mode single --image_path test.png
```

### 5. æ¨¡å‹æ ¼å¼è½¬æ¢

#### SafeTensorsæ ¼å¼ä¼˜åŠ¿
- ğŸ”’ **å®‰å…¨æ€§**: é˜²æ­¢æ¶æ„ä»£ç æ³¨å…¥ï¼Œæ›´å®‰å…¨çš„æ¨¡å‹åˆ†å‘
- âš¡ **åŠ è½½é€Ÿåº¦**: æ¯”PyTorchæ ¼å¼æ›´å¿«çš„åŠ è½½é€Ÿåº¦
- ğŸ’¾ **å­˜å‚¨ä¼˜åŒ–**: æ›´ç´§å‡‘çš„æ–‡ä»¶æ ¼å¼
- ğŸ”„ **è·¨å¹³å°å…¼å®¹**: æ”¯æŒå¤šç§æ·±åº¦å­¦ä¹ æ¡†æ¶

#### æ ¼å¼è½¬æ¢å·¥å…·
```bash
# å•ä¸ªæ¨¡å‹è½¬æ¢
uv run python convert_to_safetensors.py ./checkpoints/best.pth

# æ‰¹é‡è½¬æ¢æ•´ä¸ªç›®å½•
uv run python convert_to_safetensors.py ./checkpoints/ --batch --output_dir ./safetensor_models
```

## æ¨¡å‹æ¶æ„

### ğŸ—ï¸ åŒæ¶æ„æ”¯æŒ

#### ResNet-CRNNï¼ˆæ¨èï¼‰
- **CNNéª¨å¹²**ï¼šResNet50é¢„è®­ç»ƒç½‘ç»œï¼Œæå–é«˜è´¨é‡ç‰¹å¾
- **è‡ªé€‚åº”æ± åŒ–**ï¼šå°†ç‰¹å¾å›¾é«˜åº¦å‹ç¼©ä¸º1ï¼Œä¿æŒå®½åº¦ä½œä¸ºåºåˆ—
- **ç‰¹å¾é€‚é…**ï¼š2048â†’512ç»´åº¦æ˜ å°„
- **RNNåºåˆ—å»ºæ¨¡**ï¼š2å±‚åŒå‘LSTMï¼Œéšè—å±‚256ç»´
- **CTCè§£ç **ï¼šå¤„ç†å˜é•¿åºåˆ—è¯†åˆ«

#### åŸºç¡€CRNN
- **CNNç‰¹å¾æå–**ï¼š7å±‚å·ç§¯ç½‘ç»œï¼Œè¾“å‡º512ç»´ç‰¹å¾
- **RNNåºåˆ—å»ºæ¨¡**ï¼š2å±‚åŒå‘LSTMï¼Œéšè—å±‚256ç»´  
- **CTCè§£ç **ï¼šå¤„ç†å˜é•¿åºåˆ—è¯†åˆ«

### ğŸ›ï¸ è®­ç»ƒç­–ç•¥

#### å†»ç»“ç­–ç•¥å¯¹æ¯”
| ç­–ç•¥ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|----------|------|------|
| `none` | å¤§æ•°æ®é›†(>50k) | æ€§èƒ½æœ€ä¼˜ | è®­ç»ƒæ…¢ï¼Œæ˜“è¿‡æ‹Ÿåˆ |
| `early` | ä¸­ç­‰æ•°æ®é›†(10k-50k) | â­**æ¨èå¹³è¡¡é€‰æ‹©** | éœ€è¦è°ƒå‚ |
| `partial` | å°-ä¸­æ•°æ®é›†(5k-20k) | ç¨³å®šè®­ç»ƒ | ç‰¹å¾å—é™ |
| `all` | å°æ•°æ®é›†(<10k) | å¿«é€Ÿæ”¶æ•› | æ€§èƒ½å—é™ |

### å­—ç¬¦é›†
- æ•°å­—ï¼š0-9 (10ä¸ª)
- å¤§å†™å­—æ¯ï¼šA-Z (26ä¸ª)  
- å°å†™å­—æ¯ï¼ša-z (26ä¸ª)
- æ€»è®¡ï¼š62ä¸ªå­—ç¬¦

### ğŸ”§ è®­ç»ƒç»†èŠ‚
- **æŸå¤±å‡½æ•°**ï¼šCTC Lossï¼ˆè‡ªåŠ¨å¤„ç†å˜é•¿åºåˆ—å¯¹é½ï¼‰
- **ä¼˜åŒ–å™¨**ï¼šAdamä¼˜åŒ–å™¨ï¼Œæ”¯æŒå·®åˆ†å­¦ä¹ ç‡
- **å­¦ä¹ ç‡è°ƒåº¦**ï¼šStepLRï¼ˆæ¯20è½®è¡°å‡0.5ï¼‰
- **æ•°æ®å¢å¼º**ï¼šé¢œè‰²æŠ–åŠ¨ï¼ˆäº®åº¦ã€å¯¹æ¯”åº¦ã€é¥±å’Œåº¦ã€è‰²ç›¸ï¼‰
- **æ¢¯åº¦è£å‰ª**ï¼šæœ€å¤§æ¢¯åº¦èŒƒæ•°5.0ï¼Œé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸
- **æ­£åˆ™åŒ–**ï¼šæƒé‡è¡°å‡1e-4ï¼ŒDropoutï¼ˆLSTMå±‚é—´ï¼‰

## æ€§èƒ½æŒ‡æ ‡

æ¨¡å‹è¯„ä¼°åŒ…å«ä¸¤ä¸ªæŒ‡æ ‡ï¼š
- **åºåˆ—å‡†ç¡®ç‡**ï¼šæ•´ä¸ªéªŒè¯ç å®Œå…¨æ­£ç¡®çš„æ¯”ä¾‹
- **å­—ç¬¦å‡†ç¡®ç‡**ï¼šå•ä¸ªå­—ç¬¦æ­£ç¡®çš„æ¯”ä¾‹

## ğŸ“ˆ æ€§èƒ½è¡¨ç°

### é¢„æœŸç»“æœ
| æ¶æ„ | æ•°æ®é‡ | åºåˆ—å‡†ç¡®ç‡ | å­—ç¬¦å‡†ç¡®ç‡ | è®­ç»ƒæ—¶é—´ |
|------|--------|------------|------------|----------|
| åŸºç¡€CRNN | 10k-50k | 80-88% | 92-95% | 2-4å°æ—¶ |
| ResNet-CRNN | 10k-50k | **88-95%** | **95-98%** | 1-3å°æ—¶ |
| ResNet-CRNN | >50k | **92-97%** | **97-99%** | 3-6å°æ—¶ |

*ä»¥RTX 3090ä¸ºåŸºå‡†ï¼Œå®é™…æ€§èƒ½å¯èƒ½å› æ•°æ®è´¨é‡å’Œè¶…å‚æ•°è°ƒæ•´è€Œå¼‚*

## âš ï¸ ä½¿ç”¨é¡»çŸ¥

### è®­ç»ƒå»ºè®®
1. **GPUå†…å­˜**ï¼šResNetæ¨¡å‹éœ€è¦4GB+æ˜¾å­˜ï¼Œå»ºè®®ä½¿ç”¨æ›´å¤§batch_size
2. **æ•°æ®è´¨é‡**ï¼šç¡®ä¿ç”Ÿæˆçš„éªŒè¯ç æ¸…æ™°åº¦é€‚ä¸­ï¼Œè¿‡äºå¤æ‚ä¼šå½±å“æ”¶æ•›
3. **è¿‡æ‹Ÿåˆç›‘æ§**ï¼šä½¿ç”¨éªŒè¯é›†ç›‘æ§ï¼Œé€‚æ—¶è°ƒæ•´å­¦ä¹ ç‡å’Œå†»ç»“ç­–ç•¥
4. **åºåˆ—é•¿åº¦**ï¼šCTCå¯¹è¾“å…¥åºåˆ—é•¿åº¦æ•æ„Ÿï¼Œä¿æŒå›¾åƒå®½é«˜æ¯”ä¸€è‡´

### è°ƒå‚æŠ€å·§
- å°æ•°æ®é›†ä¼˜å…ˆè€ƒè™‘å†»ç»“ResNetä»¥é˜²è¿‡æ‹Ÿåˆ
- å¤§æ•°æ®é›†å¯ä»¥é™ä½å­¦ä¹ ç‡ã€å¢åŠ è®­ç»ƒè½®æ•°è·å¾—æ›´å¥½æ€§èƒ½
- å·®åˆ†å­¦ä¹ ç‡è®©ResNetç”¨è¾ƒå°å­¦ä¹ ç‡å¾®è°ƒï¼Œå…¶ä»–å±‚ç”¨æ­£å¸¸å­¦ä¹ ç‡

## ğŸš€ æ‰©å±•æ–¹å‘

### æ¨¡å‹æ”¹è¿›
- [ ] **Vision Transformer**ï¼šå°è¯•ViT+Transformerè§£ç å™¨
- [ ] **Attentionæœºåˆ¶**ï¼šåœ¨LSTMåæ·»åŠ æ³¨æ„åŠ›å±‚
- [ ] **å¤šå°ºåº¦ç‰¹å¾**ï¼šèåˆä¸åŒåˆ†è¾¨ç‡çš„ç‰¹å¾å›¾

### æ•°æ®å’Œåå¤„ç†  
- [ ] **é«˜çº§æ•°æ®å¢å¼º**ï¼šæ·»åŠ é€è§†å˜æ¢ã€å¼¹æ€§å½¢å˜ç­‰
- [ ] **è¯­è¨€æ¨¡å‹åå¤„ç†**ï¼šä½¿ç”¨å­—å…¸å’Œn-gramæ¨¡å‹çº é”™  
- [ ] **åŠç›‘ç£å­¦ä¹ **ï¼šåˆ©ç”¨æœªæ ‡æ³¨çš„éªŒè¯ç å›¾ç‰‡

### éƒ¨ç½²ä¼˜åŒ–
- [ ] **æ¨¡å‹é‡åŒ–**ï¼šINT8é‡åŒ–å‡å°‘æ¨¡å‹å¤§å°
- [ ] **ONNXå¯¼å‡º**ï¼šè·¨å¹³å°æ¨ç†éƒ¨ç½²
- [ ] **TensorRTä¼˜åŒ–**ï¼šGPUæ¨ç†åŠ é€Ÿ

---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ã€‚è¯·å‹¿ç”¨äºç ´è§£ä»–äººéªŒè¯ç ç­‰æ¶æ„ç›®çš„ã€‚